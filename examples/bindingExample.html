<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Data Binding in JavaScript</title>
    <!--script src="../jquery-1.4.3.min.js" type="text/javascript"></script-->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script> 
	<script type="text/javascript"> 
	if (! window.jQuery) {
	document.write(unescape("%3Cscript src='../dependencies/jquery-1.7.1.min.js' type='text/javascript'%3E%3C/script%3E")); 
	} 
	</script>
</head>
<body>
    <script src="../jQuery.as24.bind.js" type="text/javascript"></script>
This page contains a bunch of usage examples for the data binding in JavaScript.<br/>
    Name: <input id="name" value="If you see me it doesn't work."/>
	<br/>
	<div><label id="nameError">If you see me it doesn't work.</label></div><br />
    Phone: <input id="phone" value="If you see me it doesn't work."/>&nbsp;<div><label id="phoneError">If you see me it doesn't work."</label></div><br />
	Opinion: <label for="op_Y">Yes</label><input type="radio" id="op_Y" name="opinion" value="Y"/>&nbsp;<label for="op_N">No</label><input type="radio" id="op_N" name="opinion" value="N"/>&nbsp;<label for="op_O">Don't know</label><input type="radio" id="op_O" name="opinion" value="O" checked="checked"/>
	<br/>
	Comments: <textarea id="comments">If you see me it doesn't work.</textarea>
	<br/>
	Car make: <select id="make">
		<option value="">All</option>
		<option value="9">Audi</option>
		<option value="13">BMW</option>
		<option value="47">Mercedes-Benz</option>
		<option value="6">Alfa Romeo</option>
		<option value="56" selected="selected">Opel</option>
		<option value="52">Nissan</option>
		<option value="74">VW</option>
		<option value="60">Renault</option>
		<option value="21">Citroen</option>
	</select>
	<br/>
	Foods: <select id="food" multiple="multiple" size="4">
		<option value="C" selected>Mushroom</option>
		<option value="V" selected>Vegetable</option>
		<option value="M">Meat</option>
		<option value="F">Fish</option>
	</select>
	<br/>
	Languages: <label for="lng_CS">C#</label><input type="checkbox" id="lng_CS" name="languages" value="CS"/>&nbsp;<label for="lng_C">C</label><input type="checkbox" id="lng_C" name="languages" value="C"/>&nbsp;<label for="lng_J">Java</label><input type="checkbox" id="lng_J" name="languages" value="J" checked="checked"/>&nbsp;<label for="lng_JS">JavaScript</label><input type="checkbox" id="lng_JS" name="languages" value="JS" checked="checked"/>&nbsp;<label for="lng_CH">Chapel</label><input type="checkbox" id="lng_CH" name="languages" value="CH"/>&nbsp;<label for="lng_PY">Python</label><input type="checkbox" id="lng_PY" name="languages" value="PY" checked="checked"/>&nbsp;<label for="lng_GO">Go</label><input type="checkbox" id="lng_GO" name="languages" value="GO" checked="checked"/>
	<br/>
	Equipment: <label for="lkjd">Air conditioning</label><input type="checkbox" id="lkjd" alt="5" class="equi" name="oiusd"/>&nbsp;<label for="oiudmx">Automatic Air Conditioning</label><input type="checkbox" id="oiudmx" class="equi" alt="30" name="jdhdtg"/>&nbsp;<label for="srfdwgc">ESP</label><input type="checkbox" id="srfdwgc" class="equi" name="usksme" alt="1" checked="checked"/>
	<br/>
	kW: <input type="text" id="kW" />&nbsp;HP: <input type="text" id="HP"/>
	<br/>
	<div id="someInfoDiv" class="Y">This is some text, unrelated to the data, which is not visible if the opinion is No. The effect demonstrates the usage of binding to a chosen property.</div>
	<br/>	
    <button id="validator">Validate</button>
    <input type="button" id="save" value="Save" \>
    <input type="button" id="cancel" value="Cancel" \>
    <input type="button" id="boundButton" value="Some value" \>

<style>
.Y {width: 120px; padding: 1em; background-color:#ffaa00}
.N {display:none}
.O {width: 120px; padding: 1em; background-color:#999999}
</style>	
	<div id="feedbackDiv" style="position: absolute; left: 580px; top: 20px; height: 400px; width: 120px; padding: 1em; background-color:#eeeeee">Currently you chose:<br/>
	<label id="nameEcho">If you see me it doesn't work.</label><br/>
	<label id="phoneEcho">If you see me it doesn't work.</label><br/>
	<label id="opinionName">If you see me it doesn't work.</label><br/>
	<label id="commentsEcho">If you see me it doesn't work.</label><br/>
	<label id="makeName">If you see me it doesn't work.</label><br/>
	<label id="foodNames">If you see me it doesn't work.</label><br/>
	<label id="languageNames">If you see me it doesn't work.</label><br/>
	<label id="equipmentNames">If you see me it doesn't work.</label><br/>
	<label id="kwEcho">If you see me it doesn't work.</label><br/>
	<label id="hpEcho">If you see me it doesn't work.</label><br/>
	<label id="boundButtonEcho">If you see me it doesn't work.</label><br/>
	</div>
	<div id="savedFeedbackDiv" style="position: absolute; left: 740px; top: 20px; height: 400px; width: 120px; padding: 1em; background-color:#ffffaa">Last saved state, you chose:<br/>
	<label id="savedNameEcho">If you see me it doesn't work.</label><br/>
	<label id="savedPhoneEcho">If you see me it doesn't work.</label><br/>
	<label id="savedOpinionName">If you see me it doesn't work.</label><br/>
	<label id="savedCommentsEcho">If you see me it doesn't work.</label><br/>
	<label id="savedMakeName">If you see me it doesn't work.</label><br/>
	<label id="savedFoodNames">If you see me it doesn't work.</label><br/>
	<label id="savedLanguageNames">If you see me it doesn't work.</label><br/>
	<label id="savedEquipmentNames">If you see me it doesn't work.</label><br/>
	<label id="savedKwEcho">If you see me it doesn't work.</label><br/>
	<label id="savedHpEcho">If you see me it doesn't work.</label><br/>
	</div>
    <script type="text/javascript">
	
		var contact = {name:'', phone:'', opinion:'', comments:'', make:'', languages:'', food:'', equipment:'', kw:'', hp:''};
		var contactErrors = {nameError:"OK", phoneError:"OK"};
		
	// BEGIN Sample Bindings
		// put a value to equipment checkboxes, which do not have one and do not have usable names or ids either (like the ASP.net checkboxes)
		$.each($('input[class=equi]'), function(i, n){
			n['value'] = n['alt'];
		})
	
		$(contact)
		// BEGIN bidirectional binding with form elements
			.dataBind({modelAttribute:'opinion', selector:'input[name=opinion]'})
			.dataBind({modelAttribute:'name', selector:'#name', eventToBind:'keyup change'})
			.dataBind({modelAttribute:'phone', selector:'#phone', eventToBind:'keyup change'})
			.dataBind({modelAttribute:'comments', selector:'#comments'})
			.dataBind({modelAttribute:'make', selector:'#make'})
			.dataBind({modelAttribute:'languages', selector:'input[name=languages]'})
			.dataBind({modelAttribute:'food', selector:'#food'})
			.dataBind({modelAttribute:'equipment', selector:'input[class=equi]'})// now that it has a value
			.dataBind({modelAttribute:'kw', selector:'#kW'})
			.dataBind({modelAttribute:'hp', selector:'#HP'})
			.dataBind({modelAttribute:'awaken', selector:'#boundButton'})
		// END bidirectional binding with form elements
		// BEGIN unidirectional binding for human readable feedback	
			.dataBind({modelAttribute:'name', selector:'#nameEcho'})
			.dataBind({modelAttribute:'phone', selector:'#phoneEcho'})
			.dataBind({modelAttribute:'make', selector:'#makeName', translateTo:function(id){
				return $('#make option[value='+id+']').text();
			}})
			.dataBind({modelAttribute:'food', selector:'#foodNames', translateTo:function(ids){
				var values = [];
				$.each(ids.split(','), function(i, id){
					values[i] = $('#food option[value='+id+']').text();
				});
				return values.join(', ');
			}})
			.dataBind({modelAttribute:'opinion', selector:'#opinionName', translateTo:function(id){
				return $('label[for=op_'+id+']').text();
			}})
			.dataBind({modelAttribute:'languages', selector:'#languageNames', translateTo:function(ids){
				var values = [];
				$.each(ids.split(','), function(i, id){
					values[i] = $('label[for=lng_'+id+']').text();
				});
				return values.join(', ');
			}})
			.dataBind({modelAttribute:'comments', selector:'#commentsEcho'})
			.dataBind({modelAttribute:'equipment', selector:'#equipmentNames', translateTo:function(ids){
				var values = [];
				$.each(ids.split(','), function(i, id){
					var checkboxElem = $('input[class=equi][value='+id+']');
					values[i] = $('label[for='+checkboxElem.attr('id')+']').text();
				});
				return values.join(', ');
			}})
			.dataBind({modelAttribute:'kw', selector:'#kwEcho'})
			.dataBind({modelAttribute:'hp', selector:'#hpEcho'})
			.dataBind({modelAttribute:'awaken', selector:'#boundButtonEcho'})
		// END unidirectional binding for human readable feedback
		// BEGIN unidirectional binding for a chosen property (other than the normal val() or text())
			.dataBind({modelAttribute:'opinion', selector:'#someInfoDiv', domProperty:'class'})
		// END unidirectional binding for a chosen property	(other than the normal val() or text())
		;
		
		// BEGIN field relationship example (kW <-> HP)
		$(contact).bind('change', function(event){
			if(event.newValue!==event.oldValue){
				var fromVal = event.newValue, toVal;
				switch(event.attribute){
					case 'kw':
						toVal = Math.round(parseInt(fromVal, 10)/0.73549875);
						if(toVal>0 && toVal!==parseInt($(this).attr('hp'))) $(this).attr('hp', toVal);
						break;
					case 'hp':
						toVal = Math.round(parseInt(fromVal, 10)*0.73549875);
						if(toVal>0 && toVal!==parseInt($(this).attr('kw'))) $(this).attr('kw', toVal);
						break;
					// note: bidirectional relation with rounding risks cascading changes more than needed
					// 100 HP = 73.549875 kW ~= 74 kW = 100.611999... ~= 101 HP = 74.28537375 ~= 74 kW where it stableizes
					default: //nothing special to do
						break;
				}
			}
		});
		// END field relationship example (kW <-> HP)
	// END Sample Bindings

	// BEGIN PoC save and cancel functionality
		var savedState = {};
		var commit = function(transientObject, persistentObject){
			// only copy the properties found in transient object
			for(name in transientObject){
				if(!name.match('^jQuery'))
					$(persistentObject).attr(name, transientObject[name]);
			}
		}

		var rollback = function(transientObject, persistentObject){
			// only copy the properties found in transient object (the persistent object can have more fields)
			for(name in transientObject){
				if(!name.match('^jQuery'))
					$(transientObject).attr(name, persistentObject[name]);
			}
		}
		
		var save = function(){commit(contact, savedState);}
		var cancel = function(){rollback(contact, savedState);}
		
        $("#save").click(save);				
        $("#cancel").click(cancel);
		
		save(); // store this initial state
		
		$(savedState)
		// BEGIN unidirectional binding for human readable feedback	(in the second div)
			.dataBind({modelAttribute:'name', selector:'#savedNameEcho'})
			.dataBind({modelAttribute:'phone', selector:'#savedPhoneEcho'})
			.dataBind({modelAttribute:'make', selector:'#savedMakeName', translateTo:function(id){
				return $('#make option[value='+id+']').text();
			}})
			.dataBind({modelAttribute:'food', selector:'#savedFoodNames', translateTo:function(ids){
				var values = [];
				$.each(ids.split(','), function(i, id){
					values[i] = $('#food option[value='+id+']').text();
				});
				return values.join(', ');
			}})
			.dataBind({modelAttribute:'opinion', selector:'#savedOpinionName', translateTo:function(id){
				return $('label[for=op_'+id+']').text();
			}})
			.dataBind({modelAttribute:'languages', selector:'#savedLanguageNames', translateTo:function(ids){
				var values = [];
				$.each(ids.split(','), function(i, id){
					values[i] = $('label[for=lng_'+id+']').text();
				});
				return values.join(', ');
			}})
			.dataBind({modelAttribute:"comments", selector:"#savedCommentsEcho"})
			.dataBind({modelAttribute:'equipment', selector:'#savedEquipmentNames', translateTo:function(ids){
				var values = [];
				$.each(ids.split(','), function(i, id){
					var checkboxElem = $('input[class=equi][value='+id+']');
					values[i] = $('label[for='+checkboxElem.attr('id')+']').text();
				});
				return values.join(', ');
			}})
			.dataBind({modelAttribute:'kw', selector:'#savedKwEcho'})
			.dataBind({modelAttribute:'hp', selector:'#savedHpEcho'})
		// END unidirectional binding for human readable feedback (in the second div)
		;
	// END PoC save and cancel functionality
	
        // Modify contact by setting attributes via attr(), which is intercepted in order to propagate changes. 
        $(contact).attr({
            name: "Max Mustermann",
            phone: "089 123 456 789",
			opinion: "Y",
			comments: "I'm good at Software.",
			make:"47",
			languages:"CS,C,JS,J,CH",
			food:"C,V,M,F",
			equipment:"5,30",
			awaken:''
        });
		
		// DON'T SET THE MODEL LIKE THIS:
        // DO NOT: contact.name = "Some Name"; 
        // because it ignores the data linking.
		// DO THIS INSTEAD: contact.attr('name', 'Some Name');

	// BEGIN PoC validation	
		// For labels, only unidirectional binding is available
		$(contactErrors).dataBind({modelAttribute:'nameError', selector:'#nameError'})
            .dataBind({modelAttribute:'phoneError', selector:'#phoneError'})
		;

        $("#validator").click(function () {
            if(contact.name === "Name" || contact.name === "name" || contact.name === ""){
				$(contactErrors).attr({nameError: "Please provide some name."});				
			}
			else{
				$(contactErrors).attr({nameError: ""});
			}
			if(contact.phone === ""){
				$(contactErrors).attr({phoneError: "Please provide some phone number."});				
			}
			else{
				$(contactErrors).attr({phoneError: ""});
			}			
        });
	// END PoC validation	
    </script>
	
    <script type="text/javascript">
		$(contactErrors).attr({nameError: "", phoneError: ""});
		save();
	</script>
	
</body>
</html>
